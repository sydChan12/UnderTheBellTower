<script>
    const socket = io();
    let myCode = "", myName = "", amHost = false, players = [], currentHand = [], boardState = {};

    function createRoom() {
        myName = document.getElementById('user-name').value;
        if(!myName) return alert("Enter your name first!");
        socket.emit('createRoom', myName);
    }

    function joinRoom() {
        myName = document.getElementById('user-name').value;
        let code = document.getElementById('join-code').value.toUpperCase();
        if(!myName || !code) return alert("Enter your name and a room code!");
        socket.emit('joinRoom', { roomCode: code, userName: myName });
    }

    socket.on('joinedRoom', d => {
        myCode = d.roomCode; amHost = d.isHost;
        document.getElementById('start-card').style.display = 'none';
        document.getElementById('lobby-card').style.display = 'block';
        document.getElementById('room-display').innerText = `ROOM: ${myCode}`;
        if(amHost) {
            document.getElementById('host-start-btn').style.display = 'block';
            document.getElementById('wait-msg').style.display = 'none';
        }
    });

    socket.on('updatePlayerList', data => {
        players = data;
        document.getElementById('lobby-players').innerHTML = data.map(p => `<div style="padding: 5px 0; border-bottom: 1px solid #222;">${p.name} ${p.isHost ? '<span style="color:var(--p-gold); font-size: 0.6rem;">[HOST]</span>' : ''}</div>`).join('');
        document.getElementById('player-list').innerHTML = data.map(p => `<div style="padding:5px; margin:2px; background:#111; border-left:3px solid ${p.isPres?'var(--p-gold)':'#333'}; opacity:${p.alive?1:0.3}">${p.name} ${p.isPres?'ðŸ‘‘':''} ${p.isLimit?'ðŸš«':''}</div>`).join('');
    });

    socket.on('updateCounts', d => {
        document.getElementById('deck-count').innerText = d.deckCount;
        document.getElementById('discard-count').innerText = d.discardCount;
    });

    socket.on('assignRole', d => { window.roleData = d; });
    function reveal(s) { document.getElementById('id-text').innerText = s ? `${window.roleData.role}\n${window.roleData.info}` : "Identity: [Hidden]"; }

    socket.on('policyUpdated', d => {
        boardState = d; // Store for Veto checking
        const ct = document.getElementById('construction-track'); ct.innerHTML = '';
        for(let i=1; i<=6; i++){
            let p = (i===1&&d.playerCount>=9)||(i===2&&d.playerCount>=7)?"Investigate":i===3?"Peek":i===4||i===5?"Expel":"";
            ct.innerHTML += `<div class="slot ${i<=d.enactedPolicies.construction?'filled-construction':''}">${i<=d.enactedPolicies.construction?'IU':i}<div class="power-tag">${p}</div></div>`;
        }
        const tt = document.getElementById('tradition-track'); tt.innerHTML = '';
        for(let i=1; i<=5; i++) tt.innerHTML += `<div class="slot ${i<=d.enactedPolicies.tradition?'filled-tradition':''}">${i<=d.enactedPolicies.tradition?'PURDUE':i}</div>`;
        for(let i=1; i<=3; i++) { const dot = document.getElementById(`dot-${i}`); i <= d.electionTracker ? dot.classList.add('active') : dot.classList.remove('active'); }
    });

    socket.on('newRound', d => {
        document.getElementById('status').innerText = `Presidential Turn: ${d.presidentName}`;
        if(socket.id === d.presidentId){
            document.getElementById('nom-zone').style.display = 'block';
            document.getElementById('vp-sel').innerHTML = players.filter(p => p.name !== d.presidentName && p.alive && !p.isLimit).map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        } else { document.getElementById('nom-zone').style.display = 'none'; }
    });

    function nominate() {
        socket.emit('nominateVP', document.getElementById('vp-sel').value);
        document.getElementById('nom-zone').style.display = 'none';
    }

    socket.on('startVoting', d => {
        document.getElementById('v-prompt').innerText = `Elect ${d.pres} & ${d.vp}?`;
        document.getElementById('vote-overlay').style.display = 'flex';
    });

    function cast(v) { socket.emit('submitVote', v); document.getElementById('vote-overlay').style.display = 'none'; }
    
    socket.on('presDrawPhase', () => document.getElementById('draw-btn').style.display = 'block');
    
    socket.on('presDiscardPhase', hand => {
        document.getElementById('draw-btn').style.display = 'none';
        currentHand = hand;
        showPolicyChoice(true);
    });

    socket.on('vpEnactPhase', data => {
        currentHand = data.cards;
        showPolicyChoice(false);
    });

    function showPolicyChoice(isPres) {
        const container = document.getElementById('p-choices');
        document.getElementById('p-prompt').innerText = isPres ? "President: Discard 1 Card" : "VP: Enact 1 Policy";
        container.innerHTML = ''; 
        currentHand.forEach((card, i) => {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'policy-card';
            cardDiv.style.background = (card === 'Tradition') ? 'var(--p-gold)' : 'var(--iu-red)';
            cardDiv.innerText = card;
            cardDiv.onclick = () => {
                document.getElementById('policy-overlay').style.display = 'none';
                if (isPres) {
                    const disc = currentHand.splice(i, 1)[0];
                    socket.emit('presDiscard', { kept: currentHand, discarded: disc });
                } else {
                    socket.emit('vpEnact', { enacted: card, discarded: currentHand[1-i] });
                }
            };
            container.appendChild(cardDiv);
        });

        // VETO BUTTON
        if(!isPres && boardState.enactedPolicies.construction >= 5) {
            const vBtn = document.createElement('button');
            vBtn.className = 'btn btn-outline';
            vBtn.innerText = "REQUEST VETO";
            vBtn.onclick = () => { socket.emit('requestVeto'); document.getElementById('policy-overlay').style.display = 'none'; };
            container.appendChild(vBtn);
        }
        document.getElementById('policy-overlay').style.display = 'flex';
    }

    // POWER HANDLERS
    socket.on('triggerExpel', () => {
        document.getElementById('o-title').innerText = "POWER: EXPEL";
        let ops = players.filter(p => p.alive && socket.id !== p.id).map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        document.getElementById('o-content').innerHTML = `<select id="ex-sel" style="padding:10px; width:100%">${ops}</select><button class="btn btn-gold" onclick="socket.emit('powerExpel', document.getElementById('ex-sel').value); document.getElementById('overlay').style.display='none'">EXPEL</button>`;
        document.getElementById('overlay').style.display = 'flex';
    });

    socket.on('triggerInvestigate', () => {
        document.getElementById('o-title').innerText = "POWER: INVESTIGATE";
        let ops = players.filter(p => p.id !== socket.id).map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        document.getElementById('o-content').innerHTML = `<select id="inv-sel" style="padding:10px; width:100%">${ops}</select><button class="btn btn-gold" onclick="socket.emit('powerInvestigate', document.getElementById('inv-sel').value); document.getElementById('overlay').style.display='none'">INVESTIGATE</button>`;
        document.getElementById('overlay').style.display = 'flex';
    });

    socket.on('vetoRequested', () => {
        document.getElementById('o-title').innerText = "VETO REQUESTED";
        document.getElementById('o-content').innerHTML = `<p>The VP wants to discard these policies. Agree?</p><button class="btn btn-gold" onclick="socket.emit('vetoConfirmed', true); document.getElementById('overlay').style.display='none'">AGREE</button><button class="btn" onclick="socket.emit('vetoConfirmed', false); document.getElementById('overlay').style.display='none'">DENY</button>`;
        document.getElementById('overlay').style.display = 'flex';
    });

    socket.on('vetoDenied', () => alert("President denied the veto. You must enact a policy."));

    socket.on('triggerPeek', cs => {
        document.getElementById('o-title').innerText = "Deck Peek";
        document.getElementById('o-content').innerHTML = cs.map(c => `<div style="padding:10px; margin:5px; background:${c==='Tradition'?'var(--p-gold)':'var(--iu-red)'}">${c}</div>`).join('') + `<button class="btn btn-gold" onclick="socket.emit('peekFinished'); document.getElementById('overlay').style.display='none'">Done</button>`;
        document.getElementById('overlay').style.display = 'flex';
    });

    socket.on('gameStarted', () => document.getElementById('setup-screen').style.display = 'none');
    socket.on('investigateResult', d => alert(`${d.name}'s Party: ${d.party === 'Fascist' ? 'Fascist (Hoosier)' : 'Liberal (Boilermaker)'}`));
    socket.on('gameOver', m => { alert(m); location.reload(); });
    socket.on('chatMessage', d => { const h = document.getElementById('chat-history'); h.innerHTML += `<div><b>${d.user}:</b> ${d.msg}</div>`; h.scrollTop = h.scrollHeight; });
    function sendChat() { const i = document.getElementById('chat-msg'); if(i.value) { socket.emit('sendChat', i.value); i.value = ''; } }
    socket.on('errorMsg', m => alert(m));
</script>
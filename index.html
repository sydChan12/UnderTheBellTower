<!DOCTYPE html>
<html>
<head>
    <title>Bell Tower Purdue Edition</title>
    <style>
        :root { --p-gold: #CEB888; --iu-red: #990000; --bg: #0b0b0b; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        #setup-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .card { background: #111; padding: 30px; border: 2px solid var(--p-gold); border-radius: 8px; width: 320px; text-align: center; }
        input { padding: 12px; margin: 8px 0; width: 90%; background: #000; color: white; border: 1px solid #444; border-radius: 4px; }
        .btn { padding: 12px 20px; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 10px; width: 100%; transition: opacity 0.2s; }
        .btn-gold { background: var(--p-gold); color: black; }
        .btn-outline { background: transparent; border: 1px solid #444; color: #888; }

        #sidebar { width: 280px; background: #000; border-right: 1px solid #333; display: flex; flex-direction: column; }
        #player-list { flex: 1; padding: 15px; overflow-y: auto; }
        #chat-history { flex: 1; overflow-y: auto; padding: 10px; background: #050505; border-top: 1px solid #222; font-size: 0.8rem; }

        #game-area { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
        
        .pile-container { display: flex; gap: 30px; margin-bottom: 20px; }
        .card-pile { width: 70px; height: 95px; border: 2px solid var(--p-gold); border-radius: 6px; display: flex; align-items: center; justify-content: center; background: #1a1a1a; }
        .count-badge { font-weight: bold; font-size: 1.4rem; color: var(--p-gold); }
        .shuffling { animation: shufflePulse 0.8s ease-in-out 2; }
        @keyframes shufflePulse { 50% { transform: scale(1.1); box-shadow: 0 0 20px var(--p-gold); border-color: white; } }

        .tracker-row { display: flex; align-items: center; gap: 10px; margin: 10px 0; background: #111; padding: 10px; border-radius: 10px; border: 1px solid #333; }
        .chaos-dot { width: 18px; height: 18px; border-radius: 50%; border: 2px solid #444; background: #000; transition: all 0.3s; }
        .chaos-dot.active { background: var(--iu-red); box-shadow: 0 0 10px var(--iu-red); border-color: #ff4d4d; }

        .track { display: flex; gap: 10px; margin: 15px 0; }
        .slot { width: 80px; height: 110px; border: 1px dashed #444; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.6rem; font-weight: bold; text-align: center; }
        .filled-construction { background: transparent; border-style: solid; color: transparent; background-image: url('hoosierCard.png'); background-size: contain; background-repeat: no-repeat; background-position: center;}
        .filled-tradition { background: transparent; color: black; border-style: solid; color: transparent; background-image: url('boilermakerCard.png'); background-size: contain; background-repeat: no-repeat; background-position: center;}
        .power-tag { position: absolute; bottom: -20px; font-size: 0.5rem; color: var(--p-gold); }

        #overlay, #vote-overlay, #policy-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
       
        /* Investigative Dossier Style */
.dossier-card {
    background: #fdfdfd;
    color: #111;
    padding: 40px;
    border-top: 15px solid var(--p-gold);
    box-shadow: 0 0 50px rgba(0,0,0,0.5);
    transform: rotate(-1deg);
    max-width: 400px;
    font-family: 'Courier New', Courier, monospace;
}
/* This targets the cards in the President/VP choice overlay */
.policy-card {
    width: 100px;
    height: 150px;
    display: inline-block;
    margin: 10px;
    border-radius: 8px;
    cursor: pointer;
    
    /* Image Resizing Logic */
    background-size: 80%;      /* Shrinks the logo so it doesn't touch the edges */
    background-repeat: no-repeat;
    background-position: center 30%; /* Moves logo slightly up to leave room for text */
    border: 3px solid white;
    transition: transform 0.2s;
}

.policy-card:hover {
    transform: scale(1.05);
}

/* Victory Screen Style */
.victory-screen {
    text-align: center;
    animation: zoomIn 0.5s ease-out;
}
.victory-banner {
    font-size: 4rem;
    font-weight: 900;
    text-transform: uppercase;
    margin: 20px 0;
    text-shadow: 0 0 20px rgba(255,255,255,0.3);
}
@keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div id="setup-screen">
        <div class="card" id="start-card">
            <h2 style="color:var(--p-gold); margin-bottom: 20px;">UNDER THE BELL TOWER</h2>
            <input id="user-name" placeholder="Your Name">
            <hr style="border: 0; border-top: 1px solid #333; margin: 15px 0;">
            <button class="btn btn-gold" onclick="createRoom()">Create New Room</button>
            <div style="margin: 15px 0; font-size: 0.8rem; color: #666;">â€” OR â€”</div>
            <input id="join-code" placeholder="Enter 5-Digit Code">
            <button class="btn btn-outline" onclick="joinRoom()">Join Existing Room</button>
        </div>

        <div class="card" id="lobby-card" style="display:none">
    <h3 id="room-display" style="color: var(--p-gold)"></h3>
    
    <div style="text-align:left; margin: 15px 0; padding: 10px; background: #000; border: 1px solid #333; border-radius: 4px; font-size: 0.75rem; max-height: 150px; overflow-y: auto;">
        <strong style="color: var(--p-gold);">CAMPUS RULES:</strong>
        <ul style="margin: 5px 0; padding-left: 15px; color: #bbb;">
            <li>Boilermakers: Enact 5 Purdue policies.</li>
            <li>Hoosiers: Enact 6 IU policies.</li>
            <li>If 3 IU policies pass, Hoosiers win if the Bison is elected VP.</li>
            <li>Expelled players cannot vote, talk, or lead.</li>
        </ul>
    </div>

    <div style="margin-top: 10px; font-size: 0.8rem; color: #888;">PLAYERS IN LOBBY:</div>
    <div id="lobby-players" style="text-align:left; margin:10px 0; padding: 10px; background: #000; border-radius: 4px; min-height: 50px;"></div>
    
    <button id="host-start-btn" class="btn btn-gold" style="display:none" onclick="socket.emit('startGame')">Start Semester</button>
    <p id="wait-msg" style="font-size:0.8rem; opacity:0.6">Waiting for more players...</p>
</div>
    </div>

    <div id="sidebar">
        <div id="player-list"></div>
        <div id="chat-history"></div>
        <input id="chat-msg" placeholder="Chat..." onkeydown="if(event.key==='Enter') sendChat()" style="width:100%; border:none; box-sizing:border-box; padding:12px;">
        <div style="padding:15px; background:#111; border-top:1px solid var(--p-gold)">
            <p id="id-text" style="font-size:0.7rem; color:#888; white-space: pre-line;">Identity: [Hidden]</p>
            <button class="btn btn-gold" style="width:100%; padding: 8px;" onmousedown="reveal(true)" onmouseup="reveal(false)" ontouchstart="reveal(true)" ontouchend="reveal(false)">HOLD REVEAL</button>
        </div>
    </div>

    <div id="game-area">
        <div id="status" style="border:1px solid var(--p-gold); padding:10px 20px; border-radius:20px; margin-bottom:20px">Lobby</div>
        
        <div class="pile-container">
            <div style="text-align:center"><div class="card-pile" id="draw-pile-visual"><span id="deck-count" class="count-badge">0</span></div><div style="font-size:0.6rem">DRAW</div></div>
            <div style="text-align:center"><div class="card-pile" id="discard-pile-visual" style="border-color:#444"><span id="discard-count" class="count-badge" style="color:#666">0</span></div><div style="font-size:0.6rem">DISCARD</div></div>
        </div>

        <div class="tracker-row">
            <span style="font-size:0.7rem; color:#888">ELECTION TRACKER:</span>
            <div id="dot-1" class="chaos-dot"></div><div id="dot-2" class="chaos-dot"></div><div id="dot-3" class="chaos-dot"></div>
        </div>

        <div><h5>PURDUE</h5><div class="track" id="tradition-track"></div></div>
        <div style="margin-top:20px"><h5>IU</h5><div class="track" id="construction-track"></div></div>
        
        <div id="nom-zone" style="display:none; margin-top:20px">
            <select id="vp-sel" style="padding:10px; background:#000; color:white; border:1px solid var(--p-gold)"></select>
            <button class="btn btn-gold" style="width: auto; padding: 10px 20px;" onclick="nominate()">Nominate VP</button>
        </div>
        <button id="draw-btn" class="btn btn-gold" style="display:none; width: auto;" onclick="socket.emit('drawThree')">Draw 3 Cards</button>
    </div>

    <div id="vote-overlay">
        <h2 id="v-prompt"></h2>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-gold" style="width:150px" onclick="cast('Boiler Up!')">BOILER UP!</button>
            <button class="btn" style="background:var(--iu-red); width:150px; color:white;" onclick="cast('Hammer Down!')">HAMMER DOWN!</button>
        </div>
    </div>

    <div id="policy-overlay"><h2 id="p-prompt"></h2><div id="p-choices" style="display:flex"></div></div>
    <div id="overlay"><h2 id="o-title"></h2><div id="o-content"></div></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myCode = "", myName = "", amHost = false, players = [], currentHand = [];

        function createRoom() {
            myName = document.getElementById('user-name').value;
            if(!myName) return alert("Enter your name first!");
            socket.emit('createRoom', myName);
        }

        function joinRoom() {
            myName = document.getElementById('user-name').value;
            let code = document.getElementById('join-code').value.toUpperCase();
            if(!myName || !code) return alert("Enter your name and a room code!");
            socket.emit('joinRoom', { roomCode: code, userName: myName });
        }

        socket.on('joinedRoom', d => {
            myCode = d.roomCode; amHost = d.isHost;
            document.getElementById('start-card').style.display = 'none';
            document.getElementById('lobby-card').style.display = 'block';
            document.getElementById('room-display').innerText = `ROOM: ${myCode}`;
            if(amHost) {
                document.getElementById('host-start-btn').style.display = 'block';
                document.getElementById('wait-msg').style.display = 'none';
            }
        });

        socket.on('updatePlayerList', data => {
            players = data;
            // Lobby display
            document.getElementById('lobby-players').innerHTML = data.map(p => `<div style="padding: 5px 0; border-bottom: 1px solid #222;">${p.name} ${p.isHost ? '<span style="color:var(--p-gold); font-size: 0.6rem;">[HOST]</span>' : ''}</div>`).join('');
            
            // Sidebar display
            document.getElementById('player-list').innerHTML = data.map(p => `
                <div style="padding:5px; margin:2px; background:#111; border-left:3px solid ${p.isPres?'var(--p-gold)':'#333'}; opacity:${p.alive?1:0.4}">
                    <span style="${p.alive ? '' : 'text-decoration: line-through; color: var(--iu-red);'}">
                        ${p.alive ? '' : 'âœ• '}${p.name}
                    </span>
                    ${p.isPres ? ' ðŸ‘‘' : ''} 
                    ${p.isLimit ? ' ðŸš«' : ''}
                </div>
            `).join('');
        });

        socket.on('updateCounts', d => {
            document.getElementById('deck-count').innerText = d.deckCount;
            document.getElementById('discard-count').innerText = d.discardCount;
        });

        socket.on('reshuffleOccurred', () => {
            const d = document.getElementById('draw-pile-visual');
            d.classList.add('shuffling');
            setTimeout(() => d.classList.remove('shuffling'), 1600);
        });

        socket.on('assignRole', d => { window.roleData = d; });
        function reveal(s) { document.getElementById('id-text').innerText = s && window.roleData ? `${window.roleData.role}\n${window.roleData.info}` : "Identity: [Hidden]"; }

        socket.on('policyUpdated', d => {
    // 1. Update the Construction (IU) Track
    const ct = document.getElementById('construction-track');
    if (ct) {
        ct.innerHTML = '';
        for (let i = 1; i <= 6; i++) {
            // Determine which power text to show under the slot
            let powerText = "";
            if ((i === 1 && d.playerCount >= 9) || (i === 2 && d.playerCount >= 7)) {
                powerText = "Investigate";
            } else if (i === 3) {
                powerText = "Peek";
            } else if (i === 4 || i === 5) {
                powerText = "Expel";
            }

            // Check if this slot should be filled
            const isFilled = i <= d.enactedPolicies.construction;
            const filledClass = isFilled ? 'filled-construction' : '';
            const slotContent = isFilled ? '' : i; // Show number only if empty

            ct.innerHTML += `
                <div class="slot ${filledClass}">
                    ${slotContent}
                    <div class="power-tag">${powerText}</div>
                </div>`;
        }
    }

    // 2. Update the Tradition (Purdue) Track
    const tt = document.getElementById('tradition-track');
    if (tt) {
        tt.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
            const isFilled = i <= d.enactedPolicies.tradition;
            const filledClass = isFilled ? 'filled-tradition' : '';
            const slotContent = isFilled ? '' : i;

            tt.innerHTML += `<div class="slot ${filledClass}">${slotContent}</div>`;
        }
    }

    // 3. Update the Election Tracker Dots (Chaos Dots)
    for (let i = 1; i <= 3; i++) {
        const dot = document.getElementById(`dot-${i}`);
        if (dot) {
            if (i <= d.electionTracker) {
                dot.classList.add('active');
            } else {
                dot.classList.remove('active');
            }
        }
    }
});

        socket.on('newRound', d => {
            document.getElementById('status').innerText = `Presidential Turn: ${d.presidentName}`;
            if(socket.id === d.presidentId){
                document.getElementById('nom-zone').style.display = 'block';
                document.getElementById('vp-sel').innerHTML = players.filter(p => p.name !== d.presidentName && p.alive && !p.isLimit).map(p => `<option value="${p.name}">${p.name}</option>`).join('');
            } else {
                document.getElementById('nom-zone').style.display = 'none';
            }
        });

        socket.on('closeOverlay',() => {
            document.getElementById('overlay').style.display = 'none';
        })

        function nominate() {
            const val = document.getElementById('vp-sel').value;
            socket.emit('nominateVP', val);
            document.getElementById('nom-zone').style.display = 'none';
        }

        socket.on('startVoting', d => {
            const me = players.find(p => p.name === myName);
            if (me && me.alive && !me.expelled) {
                document.getElementById('v-prompt').innerText = `Elect ${d.pres} & ${d.vp}?`;
                document.getElementById('vote-overlay').style.display = 'flex';
            } else {
                document.getElementById('status').innerText = `Election: ${d.pres} & ${d.vp} (Watching)`;
                document.getElementById('vote-overlay').style.display = 'none';
            }
        });

        function cast(v) { socket.emit('submitVote', v); document.getElementById('vote-overlay').style.display = 'none'; }
        
        socket.on('presDrawPhase', () => document.getElementById('draw-btn').style.display = 'block');
        
        socket.on('presDiscardPhase', hand => {
            document.getElementById('draw-btn').style.display = 'none';
            currentHand = hand;
            showPolicyChoice(true);
        });
        // --- Add or Update these specific listeners in your index.html <script> ---

// 1. Show the dropdown menu when the President needs to expel someone
socket.on('triggerExpel', () => {
    const overlay = document.getElementById('overlay');
    const content = document.getElementById('o-content');
    document.getElementById('o-title').innerText = "SELECT STUDENT TO EXPEL";

    // Filter for players who are still alive and not already expelled
    const targets = players.filter(p => p.name !== myName && p.alive && !p.expelled);

    content.innerHTML = `
        <div style="padding:20px; text-align:center;">
            <select id="expel-sel" style="padding:10px; width:200px; background:#000; color:white; border:1px solid var(--p-gold);">
                ${targets.map(p => `<option value="${p.name}">${p.name}</option>`).join('')}
            </select>
            <br><br>
            <button class="btn btn-gold" onclick="confirmExpel()">EXPEL FROM CAMPUS</button>
        </div>
    `;
    overlay.style.display = 'flex';
});

function confirmExpel() {
    const val = document.getElementById('expel-sel').value;
    socket.emit('powerExpel', val);
    // Overlay stays open to show the "Expel Animation" coming from the server
}

// 2. Update the Player List UI to show the "Expelled" (Silenced) status
socket.on('updatePlayerList', data => {
    players = data;
    document.getElementById('lobby-players').innerHTML = data.map(p => `<div style="padding: 5px 0; border-bottom: 1px solid #222;">${p.name}</div>`).join('');
    
    document.getElementById('player-list').innerHTML = data.map(p => `
        <div style="padding:5px; margin:2px; background:#111; border-left:3px solid ${p.isPres?'var(--p-gold)':'#333'}; opacity:${p.alive?1:0.4}">
            <span style="${p.expelled ? 'color: #666; font-style: italic;' : ''}">
                ${p.name} ${p.expelled ? ' (Expelled)' : ''}
            </span>
            ${p.isPres ? ' ðŸ‘‘' : ''} 
            ${p.isLimit ? ' ðŸš«' : ''}
        </div>
    `).join('');
});

// 3. Update the Expel Animation text to match the new "Silenced" rule
socket.on('expelAnimation', d => {
    const overlay = document.getElementById('overlay');
    const content = document.getElementById('o-content');
    document.getElementById('o-title').innerText = "CAMPUS RESTRICTION";
    
    const me = players.find(p => p.id === socket.id);
    const isPres = me && me.isPres;

    content.innerHTML = `
        <div style="text-align:center; padding: 20px;">
            <h1 style="color:var(--iu-red); font-size: 3rem;">${d.name}</h1>
            <p>HAS BEEN EXPELLED FROM THE BELL TOWER</p>
            <p style="font-size:0.8rem; color:#888;">(They can no longer speak, vote, or hold office)</p>
            <hr style="border: 0; border-top: 1px solid #333; margin: 20px 0;">
            ${d.isBison ? `<h2 style="color:var(--p-gold);">THE BISON HAS BEEN DISCOVERED!</h2>` : ''}
            <div id="expel-footer">
                ${isPres ? 
                    `<button class="btn btn-gold" onclick="resumeGame()">Continue Term</button>` : 
                    `<p style="color:#666; font-style: italic;">Waiting for President to acknowledge...</p>`}
            </div>
        </div>
    `;
    overlay.style.display = 'flex';
});

       
        function resumeGame() {
            document.getElementById('overlay').style.display = 'none';
            socket.emit('resumeAfterExpel');
        }

        socket.on('vpEnactPhase', data => {
            currentHand = data.cards;
            showPolicyChoice(false);
        });

        function showPolicyChoice(isPres) {
            const container = document.getElementById('p-choices');
            document.getElementById('p-prompt').innerText = isPres ? "President: Discard 1 Card" : "VP: Enact 1 Policy";
            container.innerHTML = ''; 
            currentHand.forEach((card, i) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'policy-card';
                if (card === 'Tradition') {
                    cardDiv.style.backgroundImage = 'url(./boilermakerCard.png)';
                    cardDiv.style.backgroundColor = 'var(--p-gold)';
                } else {
                    cardDiv.style.backgroundImage = 'url(./hoosierCard.png)';
                    cardDiv.style.backgroundColor = 'var(--iu-red)';
                }
                cardDiv.innerText = "";
                cardDiv.onclick = () => {
                    document.getElementById('policy-overlay').style.display = 'none';
                    if (isPres) {
                        const disc = currentHand.splice(i, 1)[0];
                        socket.emit('presDiscard', { kept: currentHand, discarded: disc });
                    } else {
                        const en = currentHand[i];
                        const disc = currentHand.filter((_, idx) => idx !== i)[0];
                        socket.emit('vpEnact', { enacted: en, discarded: disc });
                    }
                };
                container.appendChild(cardDiv);
            });
            document.getElementById('policy-overlay').style.display = 'flex';
        }

        socket.on('triggerPeek', cs => {
            document.getElementById('o-title').innerText = "Deck Peek";
            document.getElementById('o-content').innerHTML = cs.map(c => `<div style="padding:10px; margin:5px; background:${c==='Tradition'?'var(--p-gold)':'var(--iu-red)'}">${c}</div>`).join('') + `<button class="btn btn-gold" onclick="socket.emit('peekFinished'); document.getElementById('overlay').style.display='none'">Done</button>`;
            document.getElementById('overlay').style.display = 'flex';
        });

        socket.on('gameStarted', () => document.getElementById('setup-screen').style.display = 'none');
        // --- Replace the investigateResult listener ---
socket.on('investigateResult', d => {
    const overlay = document.getElementById('overlay');
    const content = document.getElementById('o-content');
    document.getElementById('o-title').innerText = "CONFIDENTIAL RECORD";

    const partyColor = d.party === 'Fascist' ? 'var(--iu-red)' : '#006600';
    const partyName = d.party === 'Fascist' ? 'HOOSIER' : 'BOILERMAKER';

    content.innerHTML = `
        <div class="dossier-card">
            <h2 style="margin-top:0;">OFFICIAL TRANSCRIPT</h2>
            <p><strong>SUBJECT:</strong> ${d.name}</p>
            <p><strong>STATUS:</strong> PROCESSED</p>
            <hr style="border: 1px dashed #ccc;">
            <p style="font-size: 1.5rem; text-align: center; font-weight: bold; color: ${partyColor};">
                AFFILIATION: ${partyName}
            </p>
            <button class="btn btn-gold" style="margin-top:20px;" onclick="socket.emit('peekFinished'); document.getElementById('overlay').style.display='none'">CLOSE FILE</button>
        </div>
    `;
    overlay.style.display = 'flex';
});

// --- Replace the gameOver listener ---
socket.on('gameOver', m => {
    const overlay = document.getElementById('overlay');
    const content = document.getElementById('o-content');
    const isPurdueWin = m.includes("BOILERMAKERS");
    
    document.getElementById('o-title').innerText = "COMMENCEMENT";
    
    content.innerHTML = `
        <div class="victory-screen">
            <h1 class="victory-banner" style="color: ${isPurdueWin ? 'var(--p-gold)' : 'var(--iu-red)'}">
                ${m}
            </h1>
            <p style="font-size: 1.2rem; letter-spacing: 2px; color: #888;">THE SEMESTER HAS ENDED</p>
            <button class="btn btn-gold" style="width:200px; margin-top:30px;" onclick="location.reload()">Return to Lobby</button>
        </div>
    `;
    overlay.style.display = 'flex';
});
        
        socket.on('chatMessage', d => { 
            const h = document.getElementById('chat-history'); 
            const msgEl = document.createElement('div');
            if(d.color) msgEl.style.color = d.color;
            msgEl.innerHTML = `<b>${d.user}:</b> ${d.msg}`;
            h.appendChild(msgEl); 
            h.scrollTop = h.scrollHeight; 
        });

        // --- Add this to your index.html script ---

socket.on('triggerInvestigate', () => {
    const overlay = document.getElementById('overlay');
    const content = document.getElementById('o-content');
    document.getElementById('o-title').innerText = "INVESTIGATE STUDENT RECORD";

    // President can investigate anyone except themselves
    const targets = players.filter(p => p.name !== myName);

    content.innerHTML = `
        <div style="padding:20px; text-align:center;">
            <p style="font-size:0.8rem; margin-bottom:15px; color:#888;">View a student's true affiliation (Boilermaker or Hoosier).</p>
            <select id="inv-sel" style="padding:10px; width:200px; background:#000; color:white; border:1px solid var(--p-gold);">
                ${targets.map(p => `<option value="${p.name}">${p.name}</option>`).join('')}
            </select>
            <br><br>
            <button class="btn btn-gold" onclick="confirmInvestigate()">VIEW RECORD</button>
        </div>
    `;
    overlay.style.display = 'flex';
});

function confirmInvestigate() {
    const val = document.getElementById('inv-sel').value;
    socket.emit('powerInvestigate', val);
    document.getElementById('overlay').style.display = 'none';
}

        function sendChat() { const i = document.getElementById('chat-msg'); if(i.value) { socket.emit('sendChat', i.value); i.value = ''; } }
        socket.on('errorMsg', m => alert(m));
    </script>
</body>
</html>